import React, { useState, useEffect } from 'react';
import { Plus, Trash2, Users, DollarSign, Calculator, List, UserPlus, X, CheckCircle } from 'lucide-react';

const SplitBillApp = () => {
  // --- State Management ---
  const [activeTab, setActiveTab] = useState('expenses'); // 'expenses', 'settle', 'members'
  
  // é è¨­æˆå“¡
  const [users, setUsers] = useState([
    { id: 1, name: 'æˆ‘' },
    { id: 2, name: 'æœ‹å‹ A' }
  ]);
  
  // æ”¯å‡ºç´€éŒ„
  const [expenses, setExpenses] = useState([]);
  
  // æ–°å¢æ”¯å‡ºçš„è¡¨å–®ç‹€æ…‹
  const [newExpense, setNewExpense] = useState({
    description: '',
    amount: '',
    payerId: '',
    involvedUserIds: [] 
  });

  const [newUserName, setNewUserName] = useState('');

  // åˆå§‹åŒ–ï¼šç•¶ user è®Šæ›´æˆ–çµ„ä»¶åŠ è¼‰æ™‚ï¼Œç¢ºä¿è¡¨å–®é è¨­å€¼æ­£ç¢º
  useEffect(() => {
    if (users.length > 0 && !newExpense.payerId) {
      setNewExpense(prev => ({
        ...prev,
        payerId: users[0].id,
        involvedUserIds: users.map(u => u.id) // é è¨­å…¨å“¡åˆ†æ”¤
      }));
    }
  }, [users]);

  // --- Handlers ---

  const handleAddUser = () => {
    if (!newUserName.trim()) return;
    const newUser = {
      id: Date.now(),
      name: newUserName.trim()
    };
    setUsers([...users, newUser]);
    setNewUserName('');
    // è‡ªå‹•å°‡æ–°æˆå“¡åŠ å…¥ä¸‹ç­†äº¤æ˜“çš„é è¨­åˆ†æ”¤åå–®
    setNewExpense(prev => ({
      ...prev,
      involvedUserIds: [...prev.involvedUserIds, newUser.id]
    }));
  };

  const removeUser = (id) => {
    if (users.length <= 1) {
      alert("è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä½æˆå“¡");
      return;
    }
    // æª¢æŸ¥æ˜¯å¦æœ‰ç›¸é—œé€£çš„æ”¯å‡º
    const isInvolved = expenses.some(e => e.payerId === id || e.involvedUserIds.includes(id));
    if (isInvolved) {
      alert("æ­¤æˆå“¡å·²æœ‰äº¤æ˜“ç´€éŒ„ï¼Œç„¡æ³•åˆªé™¤ã€‚è«‹å…ˆåˆªé™¤ç›¸é—œäº¤æ˜“ã€‚");
      return;
    }
    setUsers(users.filter(u => u.id !== id));
  };

  const toggleInvolvedUser = (userId) => {
    setNewExpense(prev => {
      const current = prev.involvedUserIds;
      if (current.includes(userId)) {
        // å¦‚æœåªå‰©ä¸€å€‹äººï¼Œä¸å…è¨±å–æ¶ˆï¼ˆè‡³å°‘è¦æœ‰ä¸€äººåˆ†æ”¤ï¼‰
        if (current.length === 1) return prev;
        return { ...prev, involvedUserIds: current.filter(id => id !== userId) };
      } else {
        return { ...prev, involvedUserIds: [...current, userId] };
      }
    });
  };

  const handleAddExpense = () => {
    if (!newExpense.description || !newExpense.amount || Number(newExpense.amount) <= 0) {
      alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é …ç›®åç¨±èˆ‡é‡‘é¡");
      return;
    }

    const expense = {
      id: Date.now(),
      description: newExpense.description,
      amount: parseFloat(newExpense.amount),
      payerId: parseInt(newExpense.payerId),
      involvedUserIds: newExpense.involvedUserIds,
      date: new Date().toLocaleDateString()
    };

    setExpenses([expense, ...expenses]);
    
    // é‡ç½®è¡¨å–®ï¼Œä½†ä¿ç•™åˆ†æ”¤äººè¨­å®šä»¥æ–¹ä¾¿é€£çºŒè¼¸å…¥
    setNewExpense({
      ...newExpense,
      description: '',
      amount: ''
    });
  };

  const deleteExpense = (id) => {
    setExpenses(expenses.filter(e => e.id !== id));
  };

  // --- Calculation Logic ---

  const calculateSettlement = () => {
    const balances = {}; // { userId: netBalance } 
    // æ­£æ•¸ä»£è¡¨åˆ¥äººæ¬ ä»–éŒ¢ (æ‡‰æ”¶)ï¼Œè² æ•¸ä»£è¡¨ä»–æ¬ åˆ¥äººéŒ¢ (æ‡‰ä»˜)

    // åˆå§‹åŒ–é¤˜é¡
    users.forEach(u => balances[u.id] = 0);

    expenses.forEach(exp => {
      const payerId = exp.payerId;
      const amount = exp.amount;
      const splitCount = exp.involvedUserIds.length;
      const splitAmount = amount / splitCount;

      // å¢Šä»˜äºº +amount (ä»–å…ˆå‡ºäº†éŒ¢ï¼Œé€™æ˜¯ä»–çš„å‚µæ¬Š)
      if (balances[payerId] !== undefined) {
        balances[payerId] += amount;
      }

      // åˆ†æ”¤äºº -splitAmount (é€™æ˜¯ä»–å€‘çš„å‚µå‹™/æ¶ˆè²»)
      exp.involvedUserIds.forEach(uid => {
        if (balances[uid] !== undefined) {
          balances[uid] -= splitAmount;
        }
      });
    });

    // ç”¢ç”Ÿå»ºè­°è½‰å¸³è·¯å¾‘ (æœ€å°åŒ–äº¤æ˜“ç®—æ³• - ç°¡åŒ–ç‰ˆ)
    let debtors = [];
    let creditors = [];

    Object.keys(balances).forEach(userId => {
      const id = parseInt(userId);
      const val = balances[id];
      if (val < -0.01) debtors.push({ id, amount: val }); // æ¬ éŒ¢çš„äºº
      if (val > 0.01) creditors.push({ id, amount: val }); // æ”¶éŒ¢çš„äºº
    });

    // æ’åºï¼Œå¾é‡‘é¡å¤§çš„é–‹å§‹è™•ç†
    debtors.sort((a, b) => a.amount - b.amount);
    creditors.sort((a, b) => b.amount - a.amount);

    const transactions = [];
    let i = 0; // debtor index
    let j = 0; // creditor index

    while (i < debtors.length && j < creditors.length) {
      const debtor = debtors[i];
      const creditor = creditors[j];

      // å–å…©è€…çµ•å°å€¼è¼ƒå°è€…ä½œç‚ºäº¤æ˜“é‡‘é¡
      const amount = Math.min(Math.abs(debtor.amount), creditor.amount);
      
      transactions.push({
        from: users.find(u => u.id === debtor.id)?.name || 'æœªçŸ¥',
        to: users.find(u => u.id === creditor.id)?.name || 'æœªçŸ¥',
        amount: amount.toFixed(1) // ä¿ç•™ä¸€ä½å°æ•¸
      });

      // æ›´æ–°é¤˜é¡
      debtor.amount += amount;
      creditor.amount -= amount;

      // å¦‚æœæŸæ–¹çµæ¸…äº†ï¼Œç§»å‹•æŒ‡æ¨™
      if (Math.abs(debtor.amount) < 0.01) i++;
      if (creditor.amount < 0.01) j++;
    }

    return { balances, transactions };
  };

  const { balances, transactions } = calculateSettlement();

  // --- UI Components ---

  const TabButton = ({ id, label, icon: Icon }) => (
    <button
      onClick={() => setActiveTab(id)}
      className={`flex-1 py-3 flex flex-col items-center justify-center text-sm font-medium transition-colors ${
        activeTab === id 
          ? 'text-blue-600 border-t-2 border-blue-600 bg-blue-50' 
          : 'text-gray-500 hover:text-gray-700 hover:bg-gray-50'
      }`}
    >
      <Icon size={20} className="mb-1" />
      {label}
    </button>
  );

  return (
    <div className="max-w-md mx-auto h-screen flex flex-col bg-gray-100 font-sans text-gray-800">
      {/* Header */}
      <header className="bg-white shadow-sm px-4 py-3 sticky top-0 z-10">
        <div className="flex justify-between items-center">
          <h1 className="text-xl font-bold text-gray-800 flex items-center">
            <Calculator className="mr-2 text-blue-600" />
            åˆ†å¸³ç®¡å®¶
          </h1>
          <div className="text-sm text-gray-500 bg-gray-100 px-2 py-1 rounded-full">
            {expenses.length} ç­†ç´€éŒ„
          </div>
        </div>
      </header>

      {/* Main Content Area */}
      <main className="flex-1 overflow-y-auto p-4 pb-24">
        
        {/* TAB: MEMBERS */}
        {activeTab === 'members' && (
          <div className="space-y-4">
            <div className="bg-white p-4 rounded-xl shadow-sm">
              <h2 className="text-lg font-semibold mb-3 flex items-center">
                <Users className="w-5 h-5 mr-2 text-blue-500" />
                ç®¡ç†æˆå“¡
              </h2>
              <div className="flex space-x-2 mb-4">
                <input
                  type="text"
                  placeholder="è¼¸å…¥åå­—..."
                  className="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  value={newUserName}
                  onChange={(e) => setNewUserName(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && handleAddUser()}
                />
                <button 
                  onClick={handleAddUser}
                  className="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition"
                >
                  <UserPlus size={18} />
                </button>
              </div>
              
              <div className="space-y-2">
                {users.map(user => (
                  <div key={user.id} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-100">
                    <span className="font-medium text-gray-700">{user.name}</span>
                    <button 
                      onClick={() => removeUser(user.id)}
                      className="text-gray-400 hover:text-red-500 transition"
                    >
                      <Trash2 size={16} />
                    </button>
                  </div>
                ))}
              </div>
            </div>
            
            <div className="text-xs text-gray-500 text-center px-4">
              æç¤ºï¼šæ–°å¢æˆå“¡å¾Œï¼Œä»–å€‘æœƒè‡ªå‹•å‡ºç¾åœ¨è¨˜å¸³çš„é¸é …ä¸­ã€‚
            </div>
          </div>
        )}

        {/* TAB: EXPENSES (List & Add) */}
        {activeTab === 'expenses' && (
          <div className="space-y-6">
            {/* Add Expense Form */}
            <div className="bg-white p-4 rounded-xl shadow-sm border border-blue-100">
              <h2 className="text-lg font-semibold mb-4 text-blue-800">æ–°å¢ä¸€ç­†æ”¯å‡º</h2>
              
              <div className="space-y-3">
                <div className="grid grid-cols-3 gap-3">
                  <div className="col-span-2">
                    <label className="text-xs text-gray-500 block mb-1">é …ç›®</label>
                    <input
                      type="text"
                      placeholder="ä¾‹å¦‚: æ™šé¤ã€è»Šè²»"
                      className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                      value={newExpense.description}
                      onChange={(e) => setNewExpense({...newExpense, description: e.target.value})}
                    />
                  </div>
                  <div className="col-span-1">
                    <label className="text-xs text-gray-500 block mb-1">é‡‘é¡</label>
                    <input
                      type="number"
                      placeholder="0"
                      className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                      value={newExpense.amount}
                      onChange={(e) => setNewExpense({...newExpense, amount: e.target.value})}
                    />
                  </div>
                </div>

                <div>
                  <label className="text-xs text-gray-500 block mb-1">èª°å…ˆå¢Šä»˜ (æ”¯å‡ºäºº)</label>
                  <div className="flex overflow-x-auto pb-2 gap-2 hide-scrollbar">
                    {users.map(user => (
                      <button
                        key={user.id}
                        onClick={() => setNewExpense({...newExpense, payerId: user.id})}
                        className={`px-3 py-1.5 rounded-full text-sm whitespace-nowrap border transition-all ${
                          newExpense.payerId === user.id
                            ? 'bg-blue-600 text-white border-blue-600'
                            : 'bg-white text-gray-600 border-gray-200 hover:border-blue-300'
                        }`}
                      >
                        {user.name}
                      </button>
                    ))}
                  </div>
                </div>

                <div>
                  <label className="text-xs text-gray-500 block mb-1">åˆ†æ”¤çµ¦èª° (é è¨­å…¨å“¡)</label>
                  <div className="flex flex-wrap gap-2">
                    {users.map(user => {
                      const isSelected = newExpense.involvedUserIds.includes(user.id);
                      return (
                        <button
                          key={user.id}
                          onClick={() => toggleInvolvedUser(user.id)}
                          className={`px-3 py-1 rounded-md text-xs font-medium border transition-all ${
                            isSelected
                              ? 'bg-green-50 text-green-700 border-green-200'
                              : 'bg-gray-50 text-gray-400 border-transparent hover:bg-gray-100'
                          }`}
                        >
                          {isSelected && <CheckCircle size={12} className="inline mr-1" />}
                          {user.name}
                        </button>
                      );
                    })}
                  </div>
                </div>

                <button
                  onClick={handleAddExpense}
                  className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold shadow-md active:transform active:scale-95 transition mt-2"
                >
                  åŠ å…¥ç´€éŒ„
                </button>
              </div>
            </div>

            {/* Expense List */}
            <div className="space-y-3">
              <h3 className="text-sm font-semibold text-gray-500 px-1">æœ€è¿‘ç´€éŒ„</h3>
              {expenses.length === 0 ? (
                <div className="text-center py-10 text-gray-400 bg-white rounded-xl border border-dashed border-gray-300">
                  <List className="mx-auto mb-2 opacity-50" />
                  <p>é‚„æ²’æœ‰æ”¯å‡ºç´€éŒ„</p>
                </div>
              ) : (
                expenses.map(exp => {
                  const payerName = users.find(u => u.id === exp.payerId)?.name || 'æœªçŸ¥';
                  return (
                    <div key={exp.id} className="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                      <div className="flex-1">
                        <div className="font-semibold text-gray-800">{exp.description}</div>
                        <div className="text-xs text-gray-500 mt-1">
                          <span className="bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded mr-1">
                            {payerName} å¢Šä»˜
                          </span>
                          <span className="text-gray-400">
                             ({exp.involvedUserIds.length} äººåˆ†)
                          </span>
                        </div>
                      </div>
                      <div className="text-right flex items-center space-x-3">
                        <span className="font-bold text-lg text-gray-800">${exp.amount}</span>
                        <button 
                          onClick={() => deleteExpense(exp.id)}
                          className="text-gray-300 hover:text-red-500 p-1"
                        >
                          <X size={16} />
                        </button>
                      </div>
                    </div>
                  );
                })
              )}
            </div>
          </div>
        )}

        {/* TAB: SETTLEMENT (Report) */}
        {activeTab === 'settle' && (
          <div className="space-y-6">
            
            {/* Action Plan */}
            <div className="bg-gradient-to-br from-indigo-600 to-blue-700 text-white p-5 rounded-2xl shadow-lg">
              <h2 className="text-lg font-bold mb-4 flex items-center">
                <DollarSign className="mr-1" /> çµå¸³å»ºè­°
              </h2>
              {transactions.length === 0 ? (
                <div className="text-center py-4 bg-white/10 rounded-lg">
                  <p className="text-blue-100">ç›®å‰æ²’æœ‰éœ€è¦çµç®—çš„å‚µå‹™ ğŸ‰</p>
                </div>
              ) : (
                <div className="space-y-3">
                  {transactions.map((t, idx) => (
                    <div key={idx} className="bg-white/10 p-3 rounded-lg flex items-center justify-between backdrop-blur-sm border border-white/10">
                      <div className="flex items-center space-x-2">
                        <span className="font-bold">{t.from}</span>
                        <span className="text-blue-200 text-xs">çµ¦</span>
                        <span className="font-bold">{t.to}</span>
                      </div>
                      <div className="font-mono font-bold text-xl text-yellow-300">
                        ${t.amount}
                      </div>
                    </div>
                  ))}
                  <div className="text-xs text-blue-200 text-center mt-2 pt-2 border-t border-white/10">
                    æŒ‰ç…§ä»¥ä¸Šå»ºè­°è½‰å¸³ï¼Œå³å¯çµæ¸…æ‰€æœ‰è²»ç”¨ã€‚
                  </div>
                </div>
              )}
            </div>

            {/* Detailed Stats */}
            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <h3 className="text-gray-700 font-semibold mb-3">æ”¶æ”¯è©³æƒ…</h3>
              <div className="space-y-3">
                {users.map(user => {
                  const net = balances[user.id] || 0;
                  const isPositive = net > 0.01;
                  const isNegative = net < -0.01;
                  const isEven = !isPositive && !isNegative;

                  return (
                    <div key={user.id} className="flex justify-between items-center py-2 border-b border-gray-50 last:border-0">
                      <span className="text-gray-700">{user.name}</span>
                      <div className={`font-medium ${
                        isPositive ? 'text-green-600' : 
                        isNegative ? 'text-red-500' : 'text-gray-400'
                      }`}>
                        {isPositive && `æ‡‰æ”¶ $${net.toFixed(1)}`}
                        {isNegative && `æ‡‰ä»˜ $${Math.abs(net).toFixed(1)}`}
                        {isEven && "å·²çµæ¸…"}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>

            {expenses.length > 0 && (
              <button 
                onClick={() => {
                  if(confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ”¯å‡ºç´€éŒ„ä¸¦é‡æ–°é–‹å§‹å—ï¼Ÿ')) {
                    setExpenses([]);
                  }
                }}
                className="w-full py-3 text-red-500 text-sm font-medium hover:bg-red-50 rounded-lg transition"
              >
                æ¸…é™¤æ‰€æœ‰ç´€éŒ„é‡æ–°é–‹å§‹
              </button>
            )}
          </div>
        )}
      </main>

      {/* Bottom Navigation */}
      <nav className="bg-white border-t border-gray-200 flex fixed bottom-0 w-full max-w-md pb-safe">
        <TabButton id="expenses" label="è¨˜å¸³" icon={Plus} />
        <TabButton id="members
          " label="æˆå“¡" icon={Users} />
        <TabButton id="settle" label="çµç®—" icon={Calculator} />
      </nav>
      
      {/* Mobile Safe Area Spacer */}
      <div className="h-6 w-full bg-white fixed bottom-0 z-50 pointer-events-none md:hidden" />
    </div>
  );
};

export default SplitBillApp;

